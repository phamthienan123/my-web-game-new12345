<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Bảng điều khiển</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:20px}
    .top{position:fixed;top:10px;right:20px;display:flex;gap:8px;align-items:center;background:#f5f7fb;border:1px solid #e3e7ef;padding:8px 12px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .btn{display:inline-block;background:#1677ff;color:#fff;text-decoration:none;padding:8px 12px;border-radius:8px}
    .btn.red{background:#e74c3c}
    .pill{background:#eef3ff;border:1px solid #d7e2ff;border-radius:999px;padding:4px 10px}
    .container{max-width:900px;margin:90px auto 40px}
    h1{margin:0 0 16px}
    .card{border:1px solid #e8e8e8;border-radius:12px;padding:14px 16px;margin-bottom:16px}
    .quiz{display:grid;grid-template-columns:160px 1fr;gap:14px;align-items:start}
    .quiz img{max-width:160px;border-radius:10px;border:1px solid #eee}
    .opts label{display:block;margin:6px 0}
    .status{font-size:14px;opacity:.8}
  </style>
</head>
<body>
  <div class="top">
    <span class="pill">💎 {{ diamonds }}</span>
    <a href="/shop" class="btn">🛒 Cửa hàng</a>
    <a href="/logout" class="btn red">Đăng xuất</a>
  </div>

  <div class="container">
    <h1>Xin chào {{ username }}{% if highest_rank %} • Rank: {{ highest_rank|replace('rank_','')|upper }}{% endif %}</h1>

    <div class="card">
      <h3>Điểm danh hằng ngày</h3>
      {% if new_claim %}
        <a class="btn" href="/claim/daily">🎁 Nhận 10 kim cương</a>
      {% else %}
        <div class="status">✅ Hôm nay bạn đã nhận thưởng.</div>
      {% endif %}
    </div>

    <h2>Nhiệm vụ/Quiz</h2>

    {% if custom_quests %}
      {% for qid, q in custom_quests.items() %}
        <div class="card">
          <div class="quiz">
            <div>
              {% if q.image %}
                <img src="/{{ q.image }}" alt="quiz image">
              {% endif %}
            </div>
            <div>
              <h3>{{ q.title }}</h3>
              {% if q.question %}<p><b>Câu hỏi:</b> {{ q.question }}</p>{% endif %}
              <p class="status">Thưởng: {{ q.reward }} 💎</p>

              {% if q.status == 'available' or q.status == 'rejected' %}
                <form method="post" action="/submit_quiz/{{ qid }}">
                  <div class="opts">
                    {% for opt in q.options %}
                      <label>
                        <input type="radio" name="answer" value="{{ loop.index0 }}" required>
                        {{ opt }}
                      </label>
                    {% endfor %}
                  </div>
                  <button class="btn" type="submit">Nộp</button>
                  {% if q.status == 'rejected' %}
                    <span class="status">⛔ Bị từ chối, bạn có thể nộp lại.</span>
                  {% endif %}
                </form>
              {% elif q.status == 'waiting_approval' %}
                <div class="status">⏳ Đã nộp, chờ admin duyệt…</div>
              {% elif q.status == 'approved' %}
                {% set ok = (q.get('approved_result') == 'correct') %}
                <div class="status">
                  ✅ Đã duyệt • Kết quả:
                  {% if ok %}Đúng! (+{{ q.reward }}💎){% else %}Sai.{% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="status">Chưa có nhiệm vụ.</div>
    {% endif %}
  </div>
</body>
</html>
